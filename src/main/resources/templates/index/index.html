<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" 
                  xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/top_rate.css">
    <link rel="stylesheet" href="/css/now_playing.css">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" href="/css/header.css">
    <title>영화 정보 보기</title>
</head>

<style>
		.review-container {
		  display: flex; /* 자식 요소를 가로로 나열 */
		  flex-wrap: wrap; /* 공간이 부족하면 다음 줄로 넘어가게 함 */
		  gap: 20px; /* 카드 사이의 간격 */
		  justify-content: center; /* 리뷰 카드를 가운데 정렬 (선택 사항) */
		}
		.review-card {
		  width: 250px;
		  border: 1px solid #ddd; /* 10x를 1px로 수정 */
		  border-radius: 12px;
		  padding: 12px;
		  box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
		}
</style>


<body>
	<!--익명사용자(비로그인상태)isAnonymous() -->
	<!--사용자(로그인상태)isAuthenticated() -->
	
	<div id ="header" th:fragment = "header">
			<div sec:authorize="isAuthenticated()">
			    안녕하세요, 
			    <span sec:authorize="hasRole('ROLE_ADMIN')">
			        관리자 (<span sec:authentication="principal.nickname"></span>)님!
			        <b><a href="/Admin/AdminPage">관리자 페이지</a></b>
			      	
			    </span>
			    <span sec:authorize="!hasRole('ROLE_ADMIN')">
			        <span sec:authentication="principal.nickname"></span>님!
			    </span>
			</div>
			
			<div class ="userIndex" sec:authorize="isAnonymous()">
				<a href = "/UserLoginForm">로그인</a>
			</div>
			
			<div class ="userIndex"  sec:authorize="isAuthenticated()">
				<a href = "/UserMypage">내정보</a>
				<a href = "/logout">로그아웃</a>
			</div>
			
		    <form action="/MoviesList" method="GET">
			    영화 검색 : 
			    <input type ="text" id = 'movieSearch' name = "movieSearch" placeholder="영화 제목을 입력하세요"> 
			    <button type = "submit">검색</button>
			</form>
	</div>
	
	
<div id = "indexMovieList">
  	 <!-- 개봉중인 영화  -->
	 <div class="slider-container2">
  		 	<h1><a href ="/MoviesList">현재상영중</a></h1>
		    <button id="prev-btn2" class="nav-btn2">&lt;</button> 
		  	  <div id="movie-list2"></div>
		    <button id="next-btn2" class="nav-btn2">&gt;</button> 
	 </div>
 	 <div id="loading-indicator2">데이터를 불러오는 중...</div>
     	
	  <!--최고평점-->
	  <div class="slider-container">
	  		<h1><a href ="/MoviesList">최고평점</a></h1>
		    <button id="prev-btn" class="nav-btn">&lt;</button> 
		    	<div id="movie-list"></div>
		    <button id="next-btn" class="nav-btn">&gt;</button> 
	  </div>
	  <div id="loading-indicator">데이터를 불러오는 중...</div>
  		<hr>
</div>

	
<div class = "slider-container2">	
	<h2>최신 리뷰</h2>
	<div class="review-container">
		  <div class="review-card" th:each ="review : ${recentReviews}">
		    <p>[[${review.comment}]]</p>
		    <span class="rating">⭐⭐⭐⭐</span>
		    <div class="footer">
		      <span>작성자: [[${review.nickname}]]</span>
		    </div>
		    <div>
		      <span>[[${review.regDate}]]</span>
		    </div>
		  </div>	  
	</div>
	<p th:if ="${recentReviews.isEmpty()}">아직 작성된 리뷰가 없습니다.</p>
	
</div>



	<!-- -----------------------푸터--------------------------- -->
    <div id = "footer" th:fragment = "footer">
        <p><strong>ReviewPlus</strong></p>
        <p>리뷰플러스에서 사용된 모든 영화 정보는 
           <span style ="font-size:15px; font-weight:bold" >
                  <a href ="https://www.themoviedb.org/">
                        TMDb(The Movie Database)
                  </a>
         </span> 통해 제공되었습니다.
        </p>
        <p>주소:못골번영로 56번길 8<br>© 2025 ReviewPlus.All Rights Reserved.</p>
    </div>
    
    <!-- --------------------------------------------------------------------- -->
	<script>
		async function handleMovieSearch(event){
			//폼의 기본 제출(페이지이동)을 막음
			event.preventDefault();
			
			//검색 입력 필드의 값을 가져옴
			const searchInput = document.getElementById('movieSearch');
			const query = searchInput.value.trim();
			const movieListContainer = document.getElementById('movieListContainer');
			
			//검색어가 비어 있으면 경고 후 목록을 비움
			if(!query){
				alert("검색어를 입력해 주세요.");
				movieListContainer.innerHTML = ''; //기존 목록을 비움
				return;
			}
			
			//백엔드 API URL을 정확히 'query' 파라미터로 설정함
			const url = `/api/movies/search?query=${encodeURIComponent(query)}`;
			
			try{
				const response = await fetch(url);
				
				if(response.ok){
					const searchResults = await response.json();
					
					//기존 목록을 비우고 새로운 결과를 렌더링
					movieListContainer.innerHTML = '';
					
					if(searchResults && searchResults.length > 0 ){
						renderMovies(searchResults); // 렌더링함수 호출
					}else{
						movieListContainer.innerHTML = '<p>일치하는 영화 검색 결과가 없습니다.</p>'
					}
				}else {
					// 서버 응답 오류 처리
					console.error("검색 API 응답 오류:", response.status);
					movieListContainer.innerHTML = `<p>검색 중 오류가 발생했습니다(코드: ${response.status}).</p>`;
					}
				}catch(error){
					//네트워크 연결 실패 등 오류 처리
					console.error("네트워크 오류:", error);
					movieListContainer.innerHTML = '<p>서버 연결에 실패했습니다.</p>';
				}
				
			}
	</script>
 <!--영화 슬라이더 -->
 <script src="js/now_playing.js" type="module"></script>
 <script src="js/top_rate.js" type="module"></script>
 
</body>
</html>