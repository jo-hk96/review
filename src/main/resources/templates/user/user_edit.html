<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" 
                  xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>유저 정보 수정</title>
    <link rel="stylesheet" href="/css/user_mypage.css">
    <link rel="stylesheet" href="/css/footer.css">
   	<link rel="stylesheet" href="/css/user_edit.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
<button class="menu-btn" onclick="toggleMenu()">메뉴</button>

<div id="menu-list" style="display:none; position:absolute; top:100px; right:30px; 
background:white; border:1px solid #ccc; padding:15px; box-shadow:0 2px 8px rgba(0,0,0,0.2); z-index:100;">

<!-- 홈 바로가기 버튼 -->
<form action="/" method="get" style="margin-bottom:10px;">
  <button type="submit" class="home-btn">홈 바로가기</button>
   </form>
   <!-- 탈퇴 버튼 -->
  <form th:action="@{/UserDelete}" method="post">
    <button type="submit" onclick="return confirm('정말 탈퇴 하시겠습니까?')">회원 탈퇴</button>
  </form>
</div>
<script>
function toggleMenu() {
    const menu = document.getElementById('menu-list');
    if (menu.style.display === 'none' || menu.style.display === '') {
        menu.style.display = 'block';
    } else {
        menu.style.display = 'none';
    }
}
</script>

</body>
<body>
    <div class="user-edit-container">
        <h1>내 정보 수정</h1>
        
        
        <!-- 예외 메시지 출력 영역 -->
        
        <form action="/UserEdit" method="post" class="user-edit-form">
            <div class="form-group">
                <label for="email">이메일</label>
                <input type="email" id="email" name="email" th:value="${#authentication.principal.username}" readonly="readonly">
            </div>
            <div class="form-group">
                <label for="nickname">변경할 닉네임</label>
                <input type="text" id="nickname" name="nickname" th:value="${#authentication.principal.nickname}">
            </div>
            <div class="form-group">
  	 		  <label for="birthdate">생년월일</label>
  			  <input type="date" id="birthdate" name="birthdate" th:value="${#authentication.principal.birthdate}">
			</div>
            <div class="form-group">
                <label for="currentPassword">현재 비밀번호</label>
                <input type="password" id="currentPassword" name="currentPassword">
                <div th:if="${errorMessage}" class="alert" th:text="${errorMessage}"></div>
            </div>
            <div class="form-group">
                <label for="newPassword">수정 비밀번호</label>
                <input type="password" id="newPassword" name="newPassword">
            </div>
            <div class="form-group">
                <label for="confirmNewPassword">비밀번호 확인</label>
                <input type="password" id="confirmNewPassword" name="confirmNewPassword">
                <p id="passwordMismatchError" class="error-message"></p>
            </div>
            <button type="submit" class="submit-button">수정하기</button>
        </form>
    </div>
    <div th:insert="index/index :: footer"></div>
    
    
    
    
    <script>
    document.querySelector('.user-edit-form').addEventListener('submit', function(event) {
        // 폼 제출의 기본 동작(페이지 새로고침)을 막습니다.
        event.preventDefault();

        // 입력 필드의 값을 가져옵니다.
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmNewPassword = document.getElementById('confirmNewPassword').value;
        const errorMessageDiv = document.getElementById('passwordMismatchError');

        // 이전 오류 메시지를 초기화합니다.
        errorMessageDiv.textContent = '';
        errorMessageDiv.style.color = 'red';

        // 사용자가 비밀번호 변경을 시도했는지 확인합니다.
        // newPassword 또는 confirmNewPassword가 비어있지 않으면 비밀번호 변경 시도로 간주합니다.
        const isPasswordChangeAttempt = newPassword !== '' || confirmNewPassword !== '';

        if (isPasswordChangeAttempt) {
            // 비밀번호 변경을 시도했다면, 현재 비밀번호가 반드시 입력되어야 합니다.
            if (currentPassword === '') {
                errorMessageDiv.textContent = '비밀번호를 변경하려면 현재 비밀번호를 입력해야 합니다.';
                return; // 폼 제출을 중단합니다.
            }
            
            // 새 비밀번호와 비밀번호 확인이 일치하는지 확인합니다.
            if (newPassword !== confirmNewPassword) {
                errorMessageDiv.textContent = '비밀번호와 비밀번호 확인이 일치하지 않습니다.';
                return; // 폼 제출을 중단합니다.
            }
        }
        // 위의 모든 클라이언트 측 검증을 통과했다면, 폼을 서버로 제출합니다.
        // 닉네임만 변경하는 경우에도 이 부분에서 제출됩니다.
        this.submit();
    });
</script>
</body>
</html>